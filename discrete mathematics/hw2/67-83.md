# Весна 2020, задания 67-83

### 67. Будем генерировать бесконечную последовательность из $0$ и $1$ с помощью бросков честной монеты. Найдите матожидание числа бросков до выпадения трех нулей подряд.

![bruh](imgs/67.png)

$$\text{Стохастическая матрица: }P=\begin{bmatrix}
    0.5 & 0.5 & 0 & 0 \\
    0.5 & 0 & 0.5 & 0 \\
    0.5 & 0 & 0 & 0.5 \\
    0 & 0 & 0 & 1
\end{bmatrix}$$
$$\text{Непоглощающая матрица: }Q=\begin{bmatrix}
    0.5 & 0.5 & 0 \\
    0.5 & 0 & 0.5 \\
    0.5 & 0 & 0
\end{bmatrix}$$

Искомое значение - сумма элементов вектора $b_0N=\begin{bmatrix}1&0&0\end{bmatrix}(I-Q)^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}0.5&-0.5&0\\-0.5&1&-0.5\\-0.5&0&1\end{bmatrix}^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}8&4&2\\6&4&2\\4&2&2\end{bmatrix}=\begin{bmatrix}8&4&2\end{bmatrix}$

Сумма $=8+4+2=14$

Это подтверждается следующим кодом:

```c++
std::srand(std::time(nullptr));
long long iters = 1e7;
double res = 0;
for (int i = 0; i < iters; i++) {
    int cnt = 0;
    int j;
    for (j = 0; cnt < 3; j++) {
        if (rand() < (RAND_MAX / 2)) {
            cnt++;
        } else {
            cnt = 0;
        }
    }
    res += j;
}
cout << res / iters << '\n';
```

### 68. Будем генерировать бесконечную последовательность из 0 и 1 с помощью бросков честной монеты. Найдите матожидание числа бросков до первого вхождения 011.

![](imgs/68.png)

$$P=\begin{bmatrix}
    0.5 & 0.5 & 0 & 0 \\
    0 & 0.5 & 0.5 & 0 \\
    0 & 0.5 & 0 & 0.5 \\
    0 & 0 & 0 & 1
\end{bmatrix}$$

$$Q=\begin{bmatrix}
    0.5 & 0.5 & 0 \\
    0 & 0.5 & 0.5 \\
    0 & 0.5 & 0
\end{bmatrix}$$

$$b_0N=\begin{bmatrix}1&0&0\end{bmatrix}(I-Q)^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}
    0.5 & -0.5 & 0 \\
    0 & 0.5 & -0.5 \\
    0 & -0.5 & 1
\end{bmatrix}^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}
    2 & 4 & 2 \\
    0 & 4 & 2 \\
    0 & 2 & 2
\end{bmatrix}$$

Сумма $=2+4+2=8$

### 69. Будем генерировать бесконечную последовательность из $0$ и $1$ с помощью бросков честной монеты. Найдите матожидание числа бросков до первого вхождения 010.

![](imgs/69.png)

$$P=\begin{bmatrix}
    0.5 & 0.5 & 0 & 0 \\
    0 & 0.5 & 0.5 & 0 \\
    0.5 & 0 & 0 & 0.5 \\
    0 & 0 & 0 & 1
\end{bmatrix}$$

$$Q=\begin{bmatrix}
    0.5 & 0.5 & 0 \\
    0 & 0.5 & 0.5 \\
    0.5 & 0 & 0 \\
\end{bmatrix}$$

$$b_0N=\begin{bmatrix}1&0&0\end{bmatrix}(I-Q)^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}
    0.5 & -0.5 & 0 \\
    0 & 0.5 & -0.5 \\
    -0.5 & 0 & 1
\end{bmatrix}^{-1}=\begin{bmatrix}1&0&0\end{bmatrix}\begin{bmatrix}
    4 & 4 & 2 \\
    2 & 4 & 2 \\
    2 & 2 & 2
\end{bmatrix}$$

Сумма $=4+4+2=10$

### 70. Рассмотрим случайное блуждание точки на прямой, пусть точка начинает в точке $p$ ($p$ - целое) и каждую секунду переходит равновероятно на $1$ влево или вправо. Точка поглощается в точках $0$ и $n$ ($n$ целое, больше $p$). Найдите вероятность поглощения в точке $0$.

$b_0=\begin{bmatrix}0\ldots0&\stackrel{p}{1}&0\ldots 0\end{bmatrix}$

$$Q=\begin{bmatrix}
0 & 0.5 & 0 & 0 & \ldots & 0\\
0.5 & 0 & 0.5 & 0 & \ldots & 0\\
0 & 0.5 & 0 & 0.5 & \ldots & 0\\
0 & 0 & 0.5 & 0 & \ldots & 0 \\
\vdots &\vdots &\vdots &\vdots & \ddots & \vdots\\
0 & 0 & 0 & 0 & \ldots & 0
\end{bmatrix}$$

$R=\begin{bmatrix}
    0.5 & 0 \\
    0 & 0 \\
    \vdots & \vdots \\
    0 & 0.5
\end{bmatrix}$

Пусть $T=I-Q$

$$T=\begin{bmatrix}
1 & -0.5 & 0 & 0 & \ldots & 0\\
-0.5 & 1 & -0.5 & 0 & \ldots & 0\\
0 & -0.5 & 1 & -0.5 & \ldots & 0\\
0 & 0 & -0.5 & 1 & \ldots & 0 \\
\vdots &\vdots &\vdots &\vdots & \ddots & \vdots\\
0 & 0 & 0 & 0 & \ldots & 1
\end{bmatrix}$$

Утверждение: $T_{ij}^{-1}=\min_{i,j}\cdot(n-\max_{i,j}+1)\frac{2}{n+1}$.

Проверим, что $(TT^{-1})_{ij}=\delta^i_j$
$$T_i\cdot T_j^{-1}=-0.5T_{j, i-1}^{-1}+T_{ji}^{-1}-0.5T_{j, i+1}^{-1}$$

I. $j\leq i-1$
$$=\frac{2}{n+1}(-0.5j(n-i+1+1)+j(n-i+1)-0.5j(n-i-1+1))=\frac{2}{n+1}(j-j)=0$$
II. $j\geq i+1$
$$=\frac{2}{n+1}(-0.5(i-1)(n-j+1)+i(n-j+1)-0.5(i+1)(n-j+1))=\frac{2}{n+1}(n-j+1)(i-i)=0$$
III. $j=i$
$$=\frac{2}{n+1}(-0.5(i-1)(n-i+1)+i(n-i+1)-0.5i(n-i-1+1))=$$
$$=\frac{2}{n+1}(-0.5(in-i^2+i-n+i-1)+ni-i^2+i-0.5(ni-i^2))=$$
$$=\frac{2}{n+1}(-in+i^2-i+0.5(n+1)+ni-i^2+i)=$$
$$=\frac{2}{n+1}(0.5(n+1))=1$$

Доказано, что $N=T^{-1}=\ldots$

$$P(A_1)=(b^{(0)}NR)_1$$
$$b^{(0)}N=N_p$$
$$N_pR=(0.5\cdot N_{p1} \ \ 0.5\cdot N_{pn})$$
$$(N_pR)_1=0.5\cdot N_{p1}=0.5\cdot 1\cdot(n-p+1)\frac{2}{n+1}=\frac{n-p+1}{n+1}$$

Можно заметить, что $n$ - длина стороны $T$, а исходный размер $=n+1$, т.к. не поглощающие состояния $[1\ldots n-1]$, их $n-1$. Таким образом, вычтем $1$, чтобы все стало на свои места; ответ $\frac{n-p}{n}$, т.е. пропорция, как $p$ делит отрезок $[1..n-1]$, что логично.

### 72. Для заданной рациональной дроби $p/q$ постройте марковскую цепь, все переходы которой имеют вероятность $1/2$, которая имеет поглощающее состояние с вероятностью поглощения $p/q$.

$n:=\log_2q$

Построим дерево для $n$ бросков монеты со всеми исходами. Пусть $p$ исходов поглощающие, т.е. в графе в них петля; $2^n-q$ исходов не поглощающие (переходят по очереди из одного в другой). Оставшиеся исходы возврающаются в старт.
$$P(погл)=\frac{p}{2^n}+\frac{2^n-q}{2^n}\frac{p}{2^n}+\left(\frac{2^n-q}{2^n}\right)^2\frac{p}{2^n}+\ldots=\frac{p}{2^n}\left(\sum\limits_{i=0}^\infty \left(\frac{2^n-q}{2^n}\right)^i\right)=\frac{p}{2^n}\frac{2^n}{2^n-(2^n-q)}=\frac{p}{q}$$

### 73, 74

Аналогично

### 75. Рассмотрим случайное блуждание точки на прямой, пусть точка начинает в точке $0$ и каждую секунду переходит равновероятно на $1$ влево или вправо. Чему равно математическое ожидание координаты точки после $n$ шагов?

Пусть $\xi=$ координата спустя $n$ шагов. $\xi=\sum_{i=1}^n X_i$, где $X_i=\begin{cases}
    -1, & i\text{-тый шаг влево} \\
    1, & i\text{-тый шаг вправо} \\
\end{cases}$

$$\mathbb E \xi = \mathbb E \left(\sum_{i=1}^n X_i \right)=\sum_{i=1}^n \mathbb E X_i=0$$

### 76. Рассмотрим случайное блуждание точки на прямой, пусть точка начинает в точке $0$ и каждую секунду переходит равновероятно на $1$ влево или вправо. Докажите, что математическое ожидание модуля координаты точки за $n$ шагов есть $O(\sqrt n)$.

Заметим, что $\mathbb E(|\xi^2|)\geq (\mathbb E|\xi|)^2$, т.к. $0\leq \mathbb D|\xi|=\mathbb E(|\xi^2|)- (\mathbb E|\xi|)^2$.

Докажем, что $\mathbb E(|\xi^2|)=n$.

Пусть $|\xi|=$ модуль координаты спустя $n$ шагов. $|\xi|=|\sum_{i=1}^n X_i|$, где $X_i=\begin{cases}
    -1, & i\text{-тый шаг влево} \\
    1, & i\text{-тый шаг вправо} \\
\end{cases}$

$$\mathbb E(|\xi^2|)=\mathbb E\left(\sum_{i=1}^n X_i\right)^2=\mathbb E\left(\sum_{i=1}^n X_i^2 + \sum_{i=1}^n\sum_{j=1; j\not=i}^n X_iX_j\right)=\sum_{i=1}^n \mathbb E X_i^2+\sum_{i=1}^n\sum_{j=1; j\not=i}^n \mathbb E(X_iX_j)=$$

$\mathbb E X_i^2=1$; по независимости $\mathbb E(X_iX_j)=\mathbb E X_i \cdot \mathbb E X_j=0\cdot 0$

$$=\sum_{i=1}^n 1 + \sum_{i=1}^n\sum_{j=1; j\not=i}^n 0=n$$

$$n=\mathbb E(|\xi^2|)\geq (\mathbb E|\xi|)^2$$
$$\sqrt{n} \geq \mathbb E|\xi|$$

### 77. Рассмотрим случайное блуждание точки на прямой, пусть точка начинает в точке $0$ и каждую секунду переходит равновероятно на $1$ влево или вправо. Докажите, что математическое ожидание максимума координаты точки за $n$ шагов есть $O(\sqrt n)$.

Пусть $\xi=$ максимум координаты точки спустя $n$ шагов. $$

### 78. Предложите алгоритм решения задачи 48 для произвольных выигрышных строк Васи и Пети (работающий за полином от суммы длин этих строк).

Как известно, $P(A_j)$ - вероятность поглощения в $j$-тое поглощающее состояние $=b^{(0)}NR[j]$. Посчитаем $b^{(0)}NR$. Пронумеруем все состояния парами длин префиксов, которые совпадают в строках и сгенерированной последовательности, т.е. $(i,j)$. Пусть нам даны строки $s, r$ длины $n, m$. Тогда $(n,*), (*,m)$ - поглощающие состояния.

$b^{(0)}=(100\ldots 0)$, т.к. изначально мы в состоянии $(0,0)$. Построим матрицу переходов, её можно тривиально порезать на $Q$ и $R$:
<!-- 
```c
R = matrix((n-1)*(m-1), n+m-2) // проинициализирована нулями
for i = 0...n-1 // переберем поглощающие состояния, когда 2я строка выиграла
    R[(i, m-1)][i] = 0.5 // (i, m-1) -> (i, m)
for j = 0...m-1 // 1я строка
    R[(n-1, j)][j] = 0.5 // (n-1, j) -> (n, j)
```

Построим $Q$: -->

```c
preflen(str, idx)
    return len(prefix(str[:idx] + !str[idx+1], str)) // prefix ищет наибольший суффикс первого аргумента, который является префиксом второго аргумента
```
Пояснение `prefix`: например, в дз 68 можно словить $00$, тогда `preflen('011', 2) = len(prefix('00', '011')) = len('0')`

Наибольший суффикс, который префикс - хвост последовательности, которая матчит в искомую строку.

```c
for i = 0...n
    for j = 0...m
        l1 = preflen(s, i)
        l2 = preflen(r, j)
        if i == n || j == m // в поглощающем состоянии
            P[(i,j)][(i, j)] = 1
        else if s[i+1] == r[i+1] // символы совпали => либо оба откатываются, либо оба нет
            P[(i,j)][(i+1, j+1)] = 0.5
            P[(i,j)][(l1, l2)] = 0.5
        else // символы не совпали => в каждом случае ровно один откатывается
            P[(i,j)][(i+1, l2)] = 0.5
            P[(i,j)][(l1, j+1)] = 0.5

R = P[(*,*)][(n,*) || (*, m)]
Q = P\R
```

Это было $O(n\cdot m+n+m)=O(n\cdot m)$ на `for`, т.к. `preflen` преподсчитывается за $n+m$ для обеих строк; тело цикла $=O(1)$.

$O(n^2\cdot m^2)$ на построение $Q$ и $R$. $O(n^2\cdot m^2)=O((n+m)^2\cdot (n+m)^2)=O((n+m)^4)$, т.е. полином от $n+m$.

$N=(I-Q)^{-1}$ делается за $O((n\cdot m)^3)$, перемножение $bNR$ за $O((n\cdot m))$

$$P(s \text{ выиграл})=\sum\limits_{j=0}^{m-1}$$

### 81. Будем генерировать последовательность из 0 и 1 длины n с помощью бросков честной монеты. Определите, с какой вероятностью некоторый префикс этой последовательности представляет собой запись двоичного числа, которое делится на 3.

Посчитаем число строк длины $n$, не имеющих префикс, делящийся на $3$.

Пусть $a_n$ и $b_n$ - число строк длины $n$ без префикса, делящегося на $3$ и имеющих остаток при делении на $3$ $1$ и $2$, соответственно. Если мы к строке длины $n$, не делящейся на $3$, припишем $0$, то число умножится на два и тогда получится $a_n$ строк с остатком $1\cdot 2=2$ и $b_n$ строк с остатком $2\cdot 2\stackrel{mod}=1$. Если же припишем $1$, то получится $b_n$ строк с остатком $2\cdot2+1\stackrel{mod}=2$ и $0$ строк с остатком 1. Таким образом:
$$
a_{n+1}=b_n\\
b_{n+1}=a_n+b_n=b_{n-1}+b_n
$$

Это числа Фиббоначи, при этом $b_1=0; b_2=1\ \ (10)$, т.е. $b_i=F_{i-1}$

$a_{i}=b_{i-1}=F_{i-2}$

Итого $2^n-a_n-b_n=2^n - F_{n-2} - F_{n-1}=2^n-F_{n}$, тогда
$$P=\frac{2^n-F_{n}}{2^n}=1-2^{-n}F_n$$

### 82. 81, но для произвольного $p$

Пусть $a^i_n=$ число строк длины $n$ без префикса, делящегося на $p$ и имеющих остаток $i$ при делении на $p$.

Тогда $a^i_{n+1}$ это сумма $a^j_{n}$ для всех $j$, таких что $2j=i\mod p$ $+$ та же сумма, но для $2j+1=i\mod p$. Не объединяю в одну сумму, т.к. некоторые $j$ надо считать дважды.

$$\large a^i_{n+1}=\sum_{j=1;\ \  2j=i\mod 2}^{p-1} a^j_{n} + \sum_{j=1;\ \  2j+1=i\mod 2}^{p-1} a^j_{n}$$

Можно заметить, что $\vec a_{n+1}=A\vec a_{n}$, где $A$ - матрица перехода, например для $p=3$: $\begin{bmatrix}
    0 & 1 \\
    1 & 1
\end{bmatrix}$, для $p=5$ $\begin{bmatrix}
    0 & 0 & 1 & 0 \\
    1 & 0 & 1 & 0 \\
    1 & 0 & 0 & 1 \\
    0 & 1 & 0 & 1
\end{bmatrix}$

Таким образом, можно за $O(n\cdot p^2)$ посчитать $n$ умножений $1\times p$ на $p\times p$.

Можно снять смирительную рубашку и найти матрицу перехода $a_n\to a_{n+1}$ за $O(p^2)$, посчитать собственные значения за $O(p^3)$ и оценить искомое значение, т.к. $A^n\cdot a_0\xrightarrow{n\to\infty}\alpha\cdot\lambda_1$. Это может пригодиться, если $n>>p$.

### 83. В Киндер-сюрпризах бывает $n$ различных игрушек. Вы покупаете по одному Киндер-сюрпризу со случайной игрушкой (может содержать игрушку, уже попадавшуюся ранее), пока не получите каждую из $n$ игрушек. Опишите процесс с помощью цепи Маркова. Посчитайте и оцените асимптотически матожидание количества купленных Киндер-сюрпризов.

Цепь Маркова: все состояния есть битовые строки длины $n$, где $i$-тый бит значит наличие/отсутствие $i$-той игрушки. Все начинается в строке $00\ldots0$ и в матрице переходов для строки $s$ $P_{sr}=\begin{cases}1, & s\&r=s; s\oplus r=0\ldots010\ldots0 \\ 0, & \text{иначе}\end{cases}$. Штука при $1$ значит, что в $r$ добавился еще 1 бит по сравнению с $s$. Кроме того, у строки из всех единиц $P_{tt}=1, P_{ts}=0$.

Посчитаем матожидание количества покупок. Пусть $t_i$ - число тыков, чтобы получить $i$-ю новую игрушку. Вероятность вытащить $i$-ю игрушку $p_i=\frac{n-i+1}{n}$, т.к. подходят $n-(i-1)$ штук, т.к. $i-1$ уже имеются и они не нужны <small>как и дм</small>.
$$\mathbb E t_i=\sum_{j=0}^\infty (j+1)p_i(1-p_i)^j=\frac{1}{p_i}$$
$$\mathbb E \xi = \mathbb E \left(\sum_{i=1}^n t_i\right)=\sum_{i=1}^n \mathbb Et_i=\sum_{i=1}^n \frac{1}{p_i}=\sum_{i=1}^n \frac{n}{n-i+1}=n\sum_{i=1}^n\frac{1}{n-i+1}=nH_n$$

### 84. $\mathbb D$ для предыдущего задания

$$\mathbb D t_i=\mathbb Et_i^2-(\mathbb Et_i)^2=\mathbb Et_i^2-\frac{1}{p_i^2}=\sum_{j=0}^\infty (j+1)^2p_i(1-p_i)^j - \frac{1}{p_i^2}=\frac{2-p_i}{p_i^2}-\frac{1}{p_i^2}=\frac{1-p_i}{p_i^2}$$

$$\mathbb D\xi=\mathbb D \left(\sum_{i=1}^n t_i\right)=\sum_{i=1}^n \mathbb Dt_i=\sum_{i=1}^n \frac{1-p_i}{p_i^2}=\sum_{i=1}^n\frac{1-\cfrac{n-i+1}{n}}{\left(\cfrac{n-i+1}{n}\right)^2}=\sum_{i=1}^n\frac{\cfrac{i-1}{n}}{\cfrac{(n-i+1)^2}{n^2}}=\sum_{i=1}^n\frac{n(i-1)}{(n-i+1)^2}\leq$$

Эта сумма весьма грустно вычисляется с производной дигаммы, поэтому оценим:

$$\leq\sum_{i=1}^n\frac{n^2}{(n-i+1)^2}=n^2\sum_{i=1}^{n}\frac{1}{i^2}\leq\frac{\pi^2}{6}n^2$$

Пояснение насчет $\sum_{j=0}^\infty (j+1)^2p_i(1-p_i)^j$:
$$\sum_{j=0}^\infty (j+1)^2p_i(1-p_i)^j=p_i\sum_{j=0}^\infty (j+1)^2(1-p_i)^j=p_i\sum_{j=1}^\infty j^2(1-p_i)^{j-1}=$$
$$=\frac{p_i}{1-p_i}\sum_{j=1}^\infty j^2(1-p_i)^j=$$
$$\sum_{j=1}^n j^2(1-p_i)^j:=A_n$$
$$A_n=\sum_{j=1}^n ((j-1)+1)^2(1-p_i)^j=$$
$$=\sum_{j=1}^n (1-p_i)^j + \sum_{j=1}^n (j-1)^2(1-p_i)^j + \sum_{j=1}^n 2(j-1)(1-p_i)^j=$$
$$=(1-p_i)\sum_{j=1}^n (j-1)^2(1-p_i)^{j-1} + \sum_{j=1}^n 2j(1-p_i)^j - \sum_{j=1}^n (1-p_i)^j=$$
$$=(1-p_i)A_{n-1}+\sum_{j=1}^n 2j(1-p_i)^j - \sum_{j=1}^n (1-p_i)^j=$$
$$=(1-p_i)(A_{n}+n^2(1-p_i)^n)+\sum_{j=1}^n 2j(1-p_i)^j - \sum_{j=1}^n (1-p_i)^j$$
$$p_iA_n = (1-p_i)(n^2(1-p_i)^n)+\sum_{j=1}^n 2j(1-p_i)^j - \sum_{j=1}^n (1-p_i)^j$$
$$A_n = 0+\frac{1}{p_i}\left(\sum_{j=1}^n 2j(1-p_i)^j - \sum_{j=1}^n (1-p_i)^j\right)$$
$$\text{Искомое}=\lim_{n\to\infty} A_n=\frac{1}{p_i}\left(\sum_{j=1}^\infty 2j(1-p_i)^j - \sum_{j=1}^\infty (1-p_i)^j\right)=$$
$$=\frac{1}{p_i} \left(2\frac{1-p_i}{p_i^2}+\frac{1-p_i}{p_i}\right)=$$
$$=\frac{1}{p_i} (\frac{2-2p_i+p_i+p_i^2}{p_i^2})=$$